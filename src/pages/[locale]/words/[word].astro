---
import fs from "fs";
import "@fontsource/ma-shan-zheng";
import PageLayout from "@/layouts/PageLayout.astro";
import "@fontsource/twinkle-star";
import Hanzi from "@/components/widget/WritingWords.astro";
import { pinyin } from "pinyin-pro";
import type { MetaData, PinyinWord } from "@/common/types";
import Explanation from "@/components/widget/Explanation.astro";
import { getLang, supportedLang } from "@/customize/lang";
import { getIntlData } from "@/customize/intl";
import { loadWord } from "@/utils/words";
import { allList, getListIntl } from "@/customize/list";

export async function getStaticPaths() {
    const wordFiles = fs.readdirSync("src/data/words");
    let paths = [];
    for (let lang of supportedLang) {
        for (let word of wordFiles) {
            paths.push({
                params: {
                    locale: lang?.locale,
                    word: word.split(".")[0],
                },
            });
        }
    }
    return paths;
}

const { word, locale } = Astro.params;
const lang = getLang(locale);
const intlData = getIntlData(lang);

const pinyins = pinyin(word, { type: "array" });

let pinyinWords: PinyinWord[] = [];
for (let i = 0; i < word.length; i++) {
    pinyinWords.push({
        word: word[i],
        pinyin: pinyins[i],
    });
}

let wordDetail = loadWord(word);

let relatedList = allList.filter((list) =>
    list.tags.some((tag) => wordDetail.tags.includes(tag)),
);

const metadata: MetaData = {
    title: `Chinese Words - ${word}`,
    description: "Chinese Words",
    lang: lang,
};
---

<PageLayout metadata={metadata}>
    <main class="max-w-screen-md mx-auto">
        <h1 class="text-4xl text-center text-white">{word}</h1>
        <div class="mb-20">
            <Hanzi pinyinWords={pinyinWords} />
        </div>

        <!-- <div class="my-10">
            <h2 class="text-2xl border-b-[1px] py-4 font-serif">
                {intlData.word.information}
            </h2>
        </div> -->

        <div class="my-10">
            <h2 class="text-2xl py-4 font-serif">
                {intlData.word.explanation}
            </h2>
            <div>
                {
                    wordDetail.explanations.map((explanation, index) => (
                        <Explanation explanation={explanation} index={index} />
                    ))
                }
            </div>
        </div>
        <div class="my-10">
            <h2 class="text-2xl border-b-[1px] py-4 font-serif">
                {intlData.word.writing}
            </h2>
            <p class="mt-2">Click grid above to animate</p>
            <div class="my-10">
                <h2 class="text-2xl border-b-[1px] py-4 font-serif">
                    {intlData.word.relatedList}
                </h2>
                <div class="my-4">
                    {
                        relatedList.map((list) => (
                            <a
                                href={`/${lang.locale}/lists/${list.name}`}
                                class="text-blue-700"
                            >
                                {getListIntl(list, lang).title}
                            </a>
                        ))
                    }
                </div>
            </div>
            <div class="my-10">
                <h2 class="text-2xl border-b-[1px] py-4 font-serif">
                    {intlData.word.homophones}
                </h2>
            </div>
        </div>
    </main>
</PageLayout>
